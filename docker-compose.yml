
services:
  init-certs:
    image: alpine:latest
    volumes:
      - certs:/tmp/certs
      - ./init-certs.sh:/init-certs.sh
    entrypoint: ["/bin/sh", "-c", "apk add --no-cache openssl curl && /init-certs.sh OAUTH_URL=$$OAUTH_URL"]
    restart: "no"
    environment:
      - API_KEY=${API_KEY}
      - OAUTH_URL=${OAUTH_URL:-http://oauth2-server:8080}
    depends_on:
      oauth2-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/certs/hsm_ca.pem"]
      interval: 2s
      timeout: 5s
      retries: 10

  oauth2-server:
    build: .
    ports:
      - "8080:8080"
    environment:
      - PUBLIC_BASE_URL=http://localhost:8080
      - PORT=8080

      - UPSTREAM_PROVIDER_URL=${UPSTREAM_PROVIDER_URL}
      - UPSTREAM_CLIENT_ID=${UPSTREAM_CLIENT_ID}
      - UPSTREAM_CLIENT_SECRET=${UPSTREAM_CLIENT_SECRET}
      - UPSTREAM_CALLBACK_URL=http://localhost:8080/callback

      - DATABASE_TYPE=memory
      - DATABASE_PATH=/app/oauth2.db
      
      - API_KEY=${API_KEY}
      - ENABLE_REGISTRATION_API=true
      - ENABLE_TRUST_ANCHOR_API=true
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./oauth2.db:/app/oauth2.db
      - certs:/tmp/certs
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:8080/health | grep -q '\"status\":\"healthy\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  demo-app:
    image: python:3.11-alpine
    working_dir: /app
    ports:
      - "8001:8080"
    volumes:
      - certs:/tmp/certs
      - ./examples/hsm-attestation-wallet:/app
      - ./examples/hsm-attestation-wallet/generate-config.sh:/app/generate-config.sh
    command: ["/bin/sh", "-c", "chmod +x /app/generate-config.sh && /app/generate-config.sh && python3 -m http.server 8080"]
    environment:
      - API_KEY=${API_KEY}
      - HSM_DEMO_SERVER_URL=${HSM_DEMO_SERVER_URL:-http://localhost:8080}
    depends_on:
      init-certs:
        condition: service_completed_successfully
      oauth2-server:
        condition: service_healthy
        
volumes:
  certs:
